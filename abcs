using System;
using System.Net;
using System.Net.Mail;
using System.Web.Http;
using System.Web.Http.Cors;

namespace WebApplication1.Controllers
{
    [EnableCors(origins: "*", headers: "*", methods: "*")] // Cho phÃ©p test tá»« trÃ¬nh duyá»‡t
    public class MailController : ApiController
    {
        [HttpPost]
        [Route("api/mail/send")]
        public IHttpActionResult SendMail([FromBody] MailRequest request)
        {
            if (request == null)
                return BadRequest("Thiáº¿u dá»¯ liá»‡u email!");

            try
            {
                // ğŸ“¨ Cáº¥u hÃ¬nh SMTP
                string senderEmail = "Asset-sys@local.canon-vn.com.vn";
                string smtpServer = "nonauth-smtp.global.canon.co.jp";
                int smtpPort = 25;
                string smtpUser = "Asset-sys@local.canon-vn.com.vn";
                string smtpPassword = "YourPasswordHere"; // Ä‘á»•i náº¿u cáº§n

                // ğŸ§¾ Táº¡o email
                MailMessage mail = new MailMessage();
                mail.From = new MailAddress(senderEmail);
                mail.To.Add(request.To);
                mail.Subject = request.Subject ?? "ğŸ“§ ThÃ´ng bÃ¡o tá»« há»‡ thá»‘ng";
                mail.Body = request.Body ?? "hello";  // náº¿u khÃ´ng gá»­i gÃ¬, máº·c Ä‘á»‹nh lÃ  â€œhelloâ€
                mail.IsBodyHtml = true; // cho phÃ©p HTML trong ná»™i dung

                using (SmtpClient smtp = new SmtpClient(smtpServer, smtpPort))
                {
                    smtp.Credentials = new NetworkCredential(smtpUser, smtpPassword);
                    smtp.EnableSsl = true; // cÃ³ thá»ƒ táº¯t náº¿u server ná»™i bá»™ khÃ´ng yÃªu cáº§u
                    smtp.Send(mail);
                }

                return Ok(new { message = "âœ… Email Ä‘Ã£ Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng!" });
            }
            catch (Exception ex)
            {
                return BadRequest($"âŒ Lá»—i gá»­i email: {ex.Message}");
            }
        }
    }

    // ğŸ§© Model dá»¯ liá»‡u POST
    public class MailRequest
    {
        public string To { get; set; }        // NgÆ°á»i nháº­n
        public string Subject { get; set; }   // TiÃªu Ä‘á»
        public string Body { get; set; }      // Ná»™i dung email (vÃ­ dá»¥: "hello")
    }
}
